<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

    <div class="row" th:fragment="footer">
        <div class="col-xs-12"><!--Подвал--></div>
    </div>

    <th:block th:fragment="script">
<!--        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>-->
<!--        <script th:src="@{/js/bootstrap.min.js}"></script>-->

        <!-- Optional JavaScript; choose one of the two! -->

        <!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!--        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

        <!-- Option 2: jQuery, Popper.js, and Bootstrap JS
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
        -->


            <script th:src="@{/js/my.js}"></script>
<!--         или-->
        <script>
            function getAllRoles($){
                getAllRolesJson($).then(function (roles) {
                    $("[id ^= 'edit_'] select").empty();
                    $("#list-new-user select").empty();
                    for (var i = 0; i < roles.length; i++) {
                        $('<option>').attr({ name: "name", value: roles[i].name }).text(roles[i].name.replace("ROLE_", "")).appendTo("[id ^= 'edit_'] select");
                        $('<option>').attr({ name: "name", value: roles[i].name }).text(roles[i].name.replace("ROLE_", "")).appendTo("#list-new-user select");
                    }
                })
            }
            // function selectedUserRole(id, roles){
            //     for(var i = 0; i < roles.length; i++){
            //         $('select#'+ id +' option[value = '+ roles[i].name +']').prop('selected', true);
            //     }
            // }
            function modalEdit(user, allRoles, form) {

               let options = '';

                if(form == "edit") {
                    formName = "edit_";
                    formTitle = "Edit user";
                    ariaLabelledby = "exampleModalLabel";
                    idModalTitle = "exampleModalLabel";
                    requestMethod = "patch";
                    buttomClass =  "btn-primary";
                    buttomValue = "Save";
                    fieldReadonly = false;
                    getAllRoles($);
                }
                if(form == "delete") {
                    formName = "delete_";
                    formTitle = "Delete user";
                    ariaLabelledby = "userDeleteModalLabel";
                    idModalTitle = "userDeleteModalLabel";
                    requestMethod = "delete";
                    buttomClass = "btn-danger";
                    buttomValue = "Delete";
                    fieldReadonly = true;
                    for(var i=0; i<user.roles.length; i++){
                        options += '<option>' + user.roles[i].name.replace("ROLE_", "") + '</option>';
                    }
                }
                return $('<div>').attr({ class: "modal fade", id: formName + user.id, tabIndex: "-1", role: "dialog", 'aria-labelledby': ariaLabelledby, 'aria-hidden': "true" }).append(
                    $('<div>').attr({ class: "modal-dialog", role: "document" }).append(
                        $('<div>').attr({ class: "modal-content" }).append(
                            $('<div>').attr({ class: "modal-header" }).append(
                                $('<h5>').attr({ class: "modal-title", id:  idModalTitle }).text( formTitle ),
                                $('<buttom>').attr({ type: "button", class: "close", 'data-dismiss': "modal", 'aria-label': "Close" }).append(
                                    $('<span>').attr({ 'aria-hidden': "true" }).html('&#215;')
                                )
                            ),
                            $('<form>').attr({ method: requestMethod, action: "/admin/users/"+user.id }).append(
                                // $('<input>').attr({}), // hidden _method: patch or REST
                                $('<div>').attr({ class: "modal-body text-center" }).append(
                                    $('<p>').text('ID:'),
                                    $('<input>').attr({ type: "text",  name: "name", value: user.id, 'readonly': true }),
                                    $('<p>').text('Имя:'),
                                    $('<input>').attr({ type: "text",  name: "firstname", value: user.firstName, 'readonly': fieldReadonly }),
                                    $('<p>').text('Фамилия:'),
                                    $('<input>').attr({ type: "text",  name: "lastname", value: user.lastName, 'readonly': fieldReadonly }),
                                    $('<p>').text('Возраст:'),
                                    $('<input>').attr({ type: "number", step: "1", name: "age", value: user.age, 'readonly': fieldReadonly }),
                                    $('<p>').text('E-mail:'),
                                    $('<input>').attr({ type: "email",  name: "email", value: user.email, 'readonly': fieldReadonly }),
                                    $('<p>').text('Пароль:'),
                                    $('<input>').attr({ type: "password",  name: "password", 'readonly': fieldReadonly }),
                                    $('<p>').text('Роль:'),
                                    $('<p>').append(
                                        $('<select>').prop({ id: user.id, 'multiple': true, size: "3", name: "addrole", 'required': fieldReadonly }).append(
                                        // Необходимо получить весь список ролей, и выделить роли пользователя для правки, только роли пользователя для удаления
                                            options
                                        )
                                    ),
                                ),
                                $('<div>').attr({ class: "modal-footer" }).append(
                                    $('<button>').attr({ type: "button", class: "btn btn-secondary", 'data-dismiss': "modal" }).text('Close'),
                                    $('<input>').attr({ class: "btn " + buttomClass, type: "submit", value: buttomValue })
                                )
                            )
                        )
                    )
                )
            }

            function listUsers($) {
                getAllUsersJson( jQuery )
                    .then(function(users)
                    {
                        $('#allUsersTable').empty();
                        for(var i=0; i < users.length; i++ ){
                            let userRole = users[i].roles.map(
                                function (role) {
                                    return " " + role.name.replace("ROLE_", "")
                                });
                            $('<tr></tr>').append(
                                $("<th></th>").text( users[i].id ),
                                $("<td></td>").text( users[i].firstName ),
                                $("<td></td>").text( users[i].lastName ),
                                $("<td></td>").text( users[i].age ),
                                $("<td></td>").text( users[i].email ),
                                $("<td></td>").text( userRole ),//.prop( {id: role} ),
                                $("<td id='edit'></td>").append( buttonEditUser(users[i]), modalEdit(users[i], users[i].roles, "edit") ), //функция с параметрами (users[i], userRole)
                                $("<td></td>").append( buttonDeleteUser(users[i]), modalEdit(users[i], users[i].roles, "delete") ) //функция с параметрами (users[i], userRole)
                            ).appendTo('#allUsersTable');
                        }
                    })
                    .catch(function(err){
                        console.log(err.message); //выведет сообщение "не удалось выполнить..."
                    });

            }
            function addNewUser($) {
                $('<form>').attr({ id: "createUserForm" }).append( // method: "post", action: "/admin/users"
                    $('<p>').text('Введите имя:'),
                    $('<input>').attr({ type: "text",  name: "firstname", 'required': true }),
                    $('<p>').text('Введите фамилию:'),
                    $('<input>').attr({ type: "text",  name: "lastname", 'required': true }),
                    $('<p>').text('Введите возраст:'),
                    $('<input>').attr({ type: "text", name: "age", 'required': true }),
                    $('<p>').text('Введите адрес эл. почты:'),
                    $('<input>').attr({ type: "email",  name: "email", 'required': true }),
                    $('<p>').text('Введите пароль:'),
                    $('<input>').attr({ type: "password",  name: "password", 'required': true }),
                    $('<p>').text('Роль:'),
                    $('<p>').append(
                        $('<select>').prop({ 'multiple': true, size: "3", name: "roles", 'required': true })
                    ),
                    $('<input>').attr({ class: "btn btn-success", type: "submit", value: "Создать пользователя" })
                ).appendTo("#list-new-user [class = 'text-center']");
                getAllRoles($);
            }

            function createNewUserJson(newUserFormData) {

                console.log("Привет из createNewUserJson");

               return fetch('http://localhost:8088/admin/users', {
                   method: 'POST',
                   headers: {
                       Accept: "application/json",
                       'Content-Type': 'application/json;charset=utf-8',
                       referrerPolicy: "origin-when-cross-origin"
                   },
                   body: JSON.stringify(newUserFormData)
               })
                   .then(response => {
                   if(response.ok){
                       return response.json()
                   } else {
                       throw Error
                   }
               })
            }

            function sendFormCreateNewUser($) {
                let user = {

                }
                console.log("это функция sendFormCreateNewUser()");

                $("#createUserForm").submit(function (e) {
                    e.preventDefault();
                    //какие то действия
                    // console.log("Это слушатель...");

                    var $data = {};
                    $('#createUserForm').find ('input[type!="submit"], select').each(function() {
                        if(this.name == 'firstname' || this.name == 'lastname' || this.name == 'age' || this.name == 'email')
                        $data[this.name] = $(this).val();

                        if(this.name == 'roles')
                            $data[this.name] = [{ name: $(this).val() }];
                    });
                    let user = {

                    }

                    console.log("Данные:" +  JSON.stringify($data));

                    createNewUserJson($data);

                });


                // document.getElementById("#createUserForm").addEventListener('submit', function (e) {
                //     e.preventDefault();
                //
                //     console.log("это слушатель sendFormCreateNewUser()");
                //
                let formData = new FormData(document.getElementById("#createUserForm"));
                formData = Object.fromEntries(formData);
                //
                // createNewUserJson(formData);
                // })
            }


            $( document ).ready( authUserInfo ).ready( listUsers ).ready( addNewUser ).ready( sendFormCreateNewUser );
        </script>
    </th:block>

</html>


